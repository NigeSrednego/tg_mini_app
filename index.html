<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Telegram Mini App — Search & Leaderboard</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="app-container">
    <div class="wrap">
      <!-- SEARCH -->
      <section class="search-card" aria-label="Поиск пользователей">
        <div class="search-row">
          <input id="q" class="search-input" placeholder="SEARCH" autocomplete="off" />
          <button class="icon-btn" id="btnSearch" aria-label="Искать">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"></circle>
              <path d="M20 20L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"></path>
            </svg>
          </button>
        </div>
      </section>
    </div>

    <!-- CONTENT -->
    <main class="content">
      <div class="wrap">
        <section id="tab-search" class="tab-content active">
          <div class="panel">
            <h2>Search</h2>
            <p class="muted">Здесь будет список найденных пользователей/профилей. Нажми Enter в поле поиска или лупу.</p>
          </div>
        </section>

        <section id="tab-leaderboard" class="tab-content">
          <div class="panel">
            <h2>Leaderboard</h2>
            <p class="muted">Здесь появится таблица лидеров. Верстка оптимизирована под мини-окно Telegram и мобильные.</p>
          </div>
        </section>

                <!-- Тестовый блок для API Stickerdom -->
        <section class="panel">
          <h2>Test API через прокси</h2>

          <label for="userId">User ID</label>
          <input id="userId" class="search-input" placeholder="например, 951368462" />

          <details style="margin-top:10px">
            <summary>Вставить initData (если не в Telegram)</summary>
            <p class="muted">
              Если Mini App открыт <b>в Telegram</b>, initData возьмём автоматически.<br>
              Если тестируешь в браузере — вставь строку, как в твоём curl:
              <code>query_id=...&user=...&auth_date=...&signature=...&hash=...</code>
            </p>
            <textarea id="authPayload" style="width:100%;height:110px" placeholder="query_id=...&user=...&auth_date=...&signature=...&hash=..."></textarea>
          </details>

          <button id="btnRun" class="tab-btn" style="margin-top:10px">Запросить → показать сырой ответ</button>

          <pre id="out" style="white-space:pre-wrap; overflow:auto; margin-top:12px; background:rgba(0,0,0,.25); padding:10px; border-radius:12px;"></pre>
        </section>
      </div>
    </main>

    <!-- TABBAR -->
    <nav class="tabbar" role="navigation" aria-label="Главная навигация">
      <div class="tabs wrap no-pad">
        <button class="tab-btn active" data-tab="tab-search" aria-controls="tab-search" aria-selected="true">Search</button>
        <button class="tab-btn" data-tab="tab-leaderboard" aria-controls="tab-leaderboard" aria-selected="false">Leaderboard</button>
      </div>
    </nav>
  </div>

  <script>
    // Telegram Mini App init
    (function () {
      const tg = window.Telegram?.WebApp;
      try { tg?.ready(); tg?.expand(); } catch (_) {}
    })();

    // Tabs
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabs = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-tab');
        tabButtons.forEach(b => {
          const active = b === btn;
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        tabs.forEach(t => t.classList.toggle('active', t.id === id));
        // скроллим контент к началу панели, чтобы не было скачков
        document.querySelector('.content').scrollTo({ top: 0, behavior: 'smooth' });
      });
    });

    // Search hook
    const input = document.getElementById('q');
    const btnSearch = document.getElementById('btnSearch');
    function runSearch(){
      const q = input.value.trim();
      if(!q) return;
      console.log('Search:', q);
    }
    btnSearch.addEventListener('click', runSearch);
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') runSearch();
    });
  </script>
  <script>
    function getInitDataOrTextarea() {
      const tg = window.Telegram?.WebApp;
      if (tg?.initData && tg.initData.includes('hash=')) return tg.initData;
      const ta = document.getElementById('authPayload');
      return (ta?.value || '').trim();
    }

    async function getTokenViaProxy(payload) {
      const res = await fetch('/api/auth', {
        method: 'POST',
        headers: { 'content-type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: payload,
      });
      if (!res.ok) throw new Error(`/api/auth → HTTP ${res.status}`);
      const j = await res.json();
      if (!j?.ok || !j?.data) throw new Error('auth: unexpected response');
      return j.data; // JWT
    }

    async function getProfileViaProxy(userId, bearer) {
      const res = await fetch(`/api/profile?id=${encodeURIComponent(userId)}`, {
        headers: { 'authorization': `Bearer ${bearer}` },
      });
      if (!res.ok) throw new Error(`/api/profile → HTTP ${res.status}`);
      return res.json();
    }

    function showRaw(outEl, obj) {
      outEl.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    document.getElementById('btnRun').addEventListener('click', async () => {
      const out = document.getElementById('out');
      const userId = document.getElementById('userId').value.trim();
      if (!userId) return showRaw(out, 'Введите User ID');

      try {
        showRaw(out, 'Авторизация…');
        const payload = getInitDataOrTextarea();
        if (!payload) return showRaw(out, 'Нет initData. Открой в Telegram или вставь строку из curl.');

        const token = await getTokenViaProxy(payload);
        showRaw(out, `OK: токен получен\n\nЗапрашиваю профиль…`);
        const prof = await getProfileViaProxy(userId, token);
        showRaw(out, prof);
      } catch (e) {
        showRaw(out, `Ошибка: ${e.message || e}`);
      }
    });
  </script>
</body>
</html>
